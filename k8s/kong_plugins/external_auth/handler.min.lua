local a=require"socket.http"local b=require"resty.lrucache"local c={VERSION="0.0.1",PRIORITY=1000001}local function d(e)return string.format("%%%02X",string.byte(e))end;local function f(g)if g==nil then return end;g=g:gsub("\n","\r\n")g=g:gsub("([^%w ])",d)g=g:gsub(" ","+")return g end;local h=setmetatable({},{__mode="k"})local i=10^4;local j=1;local k=0;local function l(m,g,n)local o=m.auth_endpoint..'?url='..f(g)..'&token='..f(n)local p,e,q=a.request(o)if e==401 then return j end;return k end;local function r(m)local n=kong.request.get_header('authorization')n=n:gsub("Bearer ","")if string.len(n)==0 then kong.response.exit(401)end;local g=kong.request.get_host()..kong.request.get_path()local s=h[m]if not s then s=b.new(i)h[m]=s end;local t=g..n;local u=s:get(t)if u==j then kong.response.exit(401)end;if not u then local v=l(m,g,n)if v==j then s:set(t,j,60*10)kong.response.exit(401)else s:set(t,k,60*60)end end end;function c:access(m)r(m)end;return c